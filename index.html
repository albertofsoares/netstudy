<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyFlix</title>
    <link id="favicon" rel="icon" type="image/x-icon" href="">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Quill.js -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

    <!-- YouTube IFrame API -->
    <script src="https://www.youtube.com/iframe_api"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Configura√ß√£o de Design System -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        netflix: {
                            black: '#141414',
                            dark: '#181818',
                            red: '#E50914',
                            hover: '#2F2F2F'
                        },
                        neon: {
                            cyan: '#00f3ff',
                            purple: '#bc13fe',
                            green: '#39ff14'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&display=swap');

        body {
            background-color: #141414;
            color: #e5e5e5;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #141414; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #E50914; }

        .neon-text { text-shadow: 0 0 10px rgba(0, 243, 255, 0.7); }
        .scrolling-wrapper {
            display: flex; flex-wrap: nowrap; overflow-x: auto;
            -webkit-overflow-scrolling: touch; padding-bottom: 20px; scroll-behavior: smooth;
        }
        .scrolling-wrapper::-webkit-scrollbar { display: none; }
        
        .card {
            flex: 0 0 auto; width: 300px; margin-right: 15px;
            background: #181818; border-radius: 4px; position: relative; cursor: pointer;
        }
        .card:hover { transform: scale(1.05); transition: all 0.3s ease; z-index: 10; }

        .video-container {
            position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;
            border-radius: 8px; border: 1px solid #333;
        }
        .video-container iframe, .video-container div { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        .ql-toolbar { background-color: #e5e5e5; border-radius: 8px 8px 0 0; }
        .ql-container { color: #e5e5e5; font-size: 16px; border-radius: 0 0 8px 8px; background-color: #2F2F2F; }
        
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #E50914; border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Tabela Admin */
        .admin-table th { text-align: left; padding: 12px; color: #888; border-bottom: 1px solid #333; }
        .admin-table td { padding: 12px; border-bottom: 1px solid #222; }
        .admin-table tr:hover { background-color: #1f1f1f; }
        
        .phase-container { display: none; }
        .phase-active { display: block; animation: fadeIn 0.5s ease-in-out; }
    </style>
</head>
<body class="antialiased">

    <!-- Navbar -->
    <nav class="fixed top-0 w-full z-50 bg-gradient-to-b from-black to-transparent px-8 py-4 flex justify-between items-center transition-all duration-300" id="navbar">
        <div class="flex items-center gap-8">
            <h1 id="siteBrand" class="text-3xl font-black text-netflix-red tracking-tighter cursor-pointer" onclick="app.router('home')">STUDYFLIX</h1>
            <ul class="hidden md:flex gap-4 text-sm font-medium text-gray-300">
                <li class="hover:text-white cursor-pointer transition" onclick="app.router('home')">In√≠cio</li>
            </ul>
        </div>
        <div class="flex items-center gap-4">
            <button id="adminBtn" class="hidden text-neon-cyan border border-neon-cyan px-3 py-1 rounded hover:bg-neon-cyan hover:text-black transition text-xs font-bold uppercase" onclick="app.router('admin')">
                Painel CMS
            </button>
            <div id="authContainer"></div>
        </div>
    </nav>

    <!-- App Container -->
    <main id="app" class="pt-24 min-h-screen px-4 md:px-12 pb-12">
        <div class="flex justify-center mt-20"><div class="loader"></div></div>
    </main>

    <!-- Modal de Login -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-80 hidden z-[60] flex items-center justify-center backdrop-blur-sm transition-opacity">
        <div class="bg-netflix-dark p-8 rounded-lg border border-gray-700 w-full max-w-md relative shadow-2xl">
            <button onclick="authManager.toggleModal(false)" class="absolute top-3 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
            <h2 class="text-3xl font-bold mb-6 text-white text-center">Acesso</h2>
            <div class="space-y-4">
                <input type="email" id="emailInput" placeholder="Email (@userpro.com para admin)" class="w-full p-3 bg-gray-800 text-white rounded border border-gray-600">
                <input type="password" id="passInput" placeholder="Senha" class="w-full p-3 bg-gray-800 text-white rounded border border-gray-600">
                <div class="flex gap-3 pt-4">
                    <button onclick="authManager.handleLogin()" class="flex-1 bg-netflix-red text-white font-bold py-3 rounded hover:bg-red-700 transition">Entrar</button>
                    <button onclick="authManager.handleRegister()" class="flex-1 border border-gray-500 text-gray-300 font-bold py-3 rounded hover:border-white transition">Cadastrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-netflix-dark border-l-4 border-neon-cyan p-4 rounded shadow-2xl transform translate-y-full transition-transform duration-300 z-50">
        <p id="toastMsg" class="text-white font-bold"></p>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, updateDoc, setDoc, query, where, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyC38VXjnYskoAx5SLF6n3PiEgnaRtz4IJ0",
            authDomain: "studyflix53.firebaseapp.com",
            projectId: "studyflix53",
            storageBucket: "studyflix53.firebasestorage.app",
            messagingSenderId: "799853597162",
            appId: "1:799853597162:web:179f1450c419157d62a293"
        };
        const appId = "studyflix53";
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const getColRef = (colName) => collection(db, 'artifacts', appId, 'public', 'data', colName);
        const getDocRef = (colName, docId) => doc(db, 'artifacts', appId, 'public', 'data', colName, docId);
        const getSettingsRef = () => doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global');
        const getUserRef = (userId, subCol, docId) => doc(db, 'artifacts', appId, 'users', userId, subCol, docId);

        // --- STATE & UTILS ---
        const state = {
            user: null,
            isAdmin: false,
            currentView: 'home',
            settings: { siteName: "StudyFlix", welcomeMessage: "Aprenda Sem Limites.", favicon: "" },
            editingId: null // ID do item sendo editado
        };

        const utils = {
            showToast: (msg) => {
                const toast = document.getElementById('toast');
                document.getElementById('toastMsg').innerText = msg;
                toast.classList.remove('translate-y-full');
                setTimeout(() => toast.classList.add('translate-y-full'), 3000);
            },
            getYouTubeID: (url) => {
                if (!url) return null;
                const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/);
                return (match && match[2].length === 11) ? match[2] : null;
            },
            stripHtml: (html) => {
                let tmp = document.createElement("DIV");
                tmp.innerHTML = html;
                return tmp.textContent || "";
            }
        };

        // --- APP LOGIC (STARTUP & HOME) ---
        const mainApp = {
            init: async () => {
                // Carregar Configura√ß√µes Globais
                try {
                    const snap = await getDoc(getSettingsRef());
                    if (snap.exists()) state.settings = { ...state.settings, ...snap.data() };
                    mainApp.applySettings();
                } catch (e) { console.log("Usando configs padr√£o"); }
            },

            applySettings: () => {
                document.title = state.settings.siteName;
                document.getElementById('siteBrand').innerText = state.settings.siteName.toUpperCase();
                if(state.settings.favicon) document.getElementById('favicon').href = state.settings.favicon;
            },

            router: (view, params = null) => {
                state.currentView = view;
                const container = document.getElementById('app');
                window.speechSynthesis.cancel();
                
                if (view === 'home') mainApp.renderHome(container);
                else if (view === 'player') mainApp.renderPlayer(container, params);
                else if (view === 'admin') adminManager.init(container);
            },

            renderHome: async (container) => {
                container.innerHTML = `<div class="flex justify-center mt-20"><div class="loader"></div></div>`;
                try {
                    const [subSnap, unitSnap, lessonSnap] = await Promise.all([
                        getDocs(getColRef("subjects")),
                        getDocs(getColRef("units")),
                        getDocs(getColRef("lessons"))
                    ]);

                    let html = `
                        <div class="mb-10 animate-fade-in">
                            <h1 class="text-5xl md:text-7xl font-black mb-4 text-white">${state.settings.welcomeMessage}</h1>
                            <p class="text-xl text-gray-400 max-w-2xl">Assista aulas como se fossem sua s√©rie favorita.</p>
                        </div>
                    `;

                    if (subSnap.empty) html += `<div class="text-gray-500">Nenhum conte√∫do. Acesse o CMS para criar.</div>`;

                    subSnap.forEach(sub => {
                        html += `
                            <div class="flex items-center gap-4 mt-12 mb-4 group cursor-pointer" onclick="window.startSeries('${sub.id}')">
                                <h2 class="text-3xl font-bold text-white group-hover:text-neon-cyan transition">${sub.data().title}</h2>
                                <div class="bg-netflix-red text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition"><i class="fas fa-play"></i> INICIAR</div>
                            </div>`;
                        
                        const subUnits = unitSnap.docs.filter(u => u.data().subjectId === sub.id);
                        subUnits.forEach(unit => {
                            html += `<div class="mb-6 ml-4"><h3 class="text-lg text-gray-400 mb-2 uppercase tracking-widest text-sm font-bold">${unit.data().title}</h3><div class="scrolling-wrapper">`;
                            
                            const unitLessons = lessonSnap.docs.filter(l => l.data().unitId === unit.id);
                            unitLessons.forEach(lesson => {
                                const ytId = utils.getYouTubeID(lesson.data().videoUrl);
                                const thumb = ytId ? `https://img.youtube.com/vi/${ytId}/mqdefault.jpg` : 'https://placehold.co/300x169';
                                html += `
                                    <div class="card card-hover" onclick="window.playLesson('${lesson.id}')">
                                        <div class="h-40 overflow-hidden rounded-t"><img src="${thumb}" class="w-full h-full object-cover opacity-80 hover:opacity-100 transition"></div>
                                        <div class="p-3"><h4 class="text-white font-bold text-sm truncate">${lesson.data().title}</h4></div>
                                    </div>`;
                            });
                            html += `</div></div>`;
                        });
                    });
                    container.innerHTML = html;
                } catch (e) { container.innerHTML = `<p class="text-red-500">Erro: ${e.message}</p>`; }
            },

            // --- PLAYER L√ìGICA (Simplificada para brevidade, mant√©m a l√≥gica anterior) ---
            renderPlayer: async (container, lessonId) => {
                // ... (L√≥gica do Player mantida intacta, apenas recuperando dados)
                // Usando a estrutura de fases anterior
                const docSnap = await getDoc(getDocRef("lessons", lessonId));
                if (!docSnap.exists()) return container.innerHTML = "Erro.";
                const data = docSnap.data();
                const ytId = utils.getYouTubeID(data.videoUrl);

                // Buscar unidade para navega√ß√£o
                const unitLessonsSnap = await getDocs(query(getColRef("lessons"), where("unitId", "==", data.unitId)));
                const unitLessons = unitLessonsSnap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => a.createdAt.localeCompare(b.createdAt));
                const currentIndex = unitLessons.findIndex(l => l.id === lessonId);
                const nextLessonId = (currentIndex !== -1 && currentIndex < unitLessons.length - 1) ? unitLessons[currentIndex + 1].id : null;
                
                window.currentLessonId = lessonId;
                window.nextLessonId = nextLessonId;
                window.hasFile = !!data.fileUrl;

                container.innerHTML = `
                    <div class="max-w-5xl mx-auto animate-fade-in relative min-h-[80vh] flex flex-col justify-center">
                        <div class="absolute top-0 left-0 w-full flex justify-between items-center mb-6 z-10">
                            <button onclick="app.router('home')" class="text-gray-400 hover:text-white flex items-center gap-2"><i class="fas fa-arrow-left"></i> Sair</button>
                            <span class="text-sm text-gray-500 uppercase font-bold tracking-widest">Aula ${currentIndex+1}/${unitLessons.length}</span>
                        </div>
                        <div id="phase1" class="phase-container phase-active w-full">
                            <h1 class="text-3xl font-bold mb-4 text-white text-center">${data.title}</h1>
                            <div class="video-container mx-auto"><div id="yt-player"></div></div>
                        </div>
                        <div id="phase2" class="phase-container w-full text-center">
                            <h2 class="text-3xl font-bold mb-8 text-white">Leitura üìö</h2>
                            ${data.fileUrl ? `<a href="${data.fileUrl}" target="_blank" class="bg-white text-black px-6 py-3 rounded font-bold hover:bg-gray-200 transition mb-6 inline-block">Abrir Material</a>` : '<p class="text-gray-500 mb-8">Sem anexo.</p>'}
                            <br><button onclick="window.nextPhase(3)" class="bg-neon-cyan text-black font-bold px-8 py-3 rounded-full hover:bg-cyan-300 transition">Ouvir Resumo <i class="fas fa-arrow-right ml-2"></i></button>
                        </div>
                        <div id="phase3" class="phase-container w-full">
                            <div class="max-w-3xl mx-auto bg-netflix-dark p-8 rounded-lg border border-neon-purple">
                                <h2 class="text-2xl font-bold text-white mb-4 animate-pulse">üîä Ouvindo...</h2>
                                <div id="summaryText" class="prose prose-invert text-gray-300 mb-6">${data.summary || "Sem resumo."}</div>
                            </div>
                        </div>
                    </div>
                `;

                if (window.YT && window.YT.Player) {
                    new YT.Player('yt-player', {
                        height: '100%', width: '100%', videoId: ytId,
                        playerVars: { 'autoplay': 1, 'controls': 1 },
                        events: { 'onStateChange': (e) => { if (e.data === YT.PlayerState.ENDED) window.nextPhase(2); } }
                    });
                }
            }
        };

        // --- ADMIN / CMS LOGIC (REFATORADO) ---
        const adminManager = {
            init: (container) => {
                if (!state.isAdmin) return mainApp.router('home');
                state.editingId = null; // Reset edit state
                
                container.innerHTML = `
                    <div class="max-w-6xl mx-auto">
                        <h2 class="text-4xl font-bold mb-8 text-neon-cyan">Sistema de Gest√£o (CMS)</h2>
                        <div class="flex gap-4 mb-8 border-b border-gray-700 pb-4 overflow-x-auto">
                            <button onclick="window.renderAdminTab('settings')" class="text-white hover:text-neon-purple font-bold px-4 py-2 bg-gray-800 rounded">‚öôÔ∏è Configura√ß√µes</button>
                            <button onclick="window.renderAdminTab('subject')" class="text-white hover:text-neon-purple font-bold px-4 py-2 bg-gray-800 rounded">üìö Mat√©rias</button>
                            <button onclick="window.renderAdminTab('unit')" class="text-white hover:text-neon-purple font-bold px-4 py-2 bg-gray-800 rounded">üìë Unidades</button>
                            <button onclick="window.renderAdminTab('lesson')" class="text-white hover:text-neon-purple font-bold px-4 py-2 bg-gray-800 rounded">üé• Aulas</button>
                        </div>
                        <div id="adminContent" class="bg-netflix-dark p-6 rounded-lg shadow-lg min-h-[400px]"></div>
                    </div>
                `;
                window.renderAdminTab('settings'); // Default tab
            },

            // Renderiza o conte√∫do da aba selecionada
            renderTab: async (type) => {
                const content = document.getElementById('adminContent');
                content.innerHTML = '<div class="loader mx-auto"></div>';
                state.editingId = null; // Reset ao trocar de aba

                if (type === 'settings') {
                    // TAB CONFIGURA√á√ïES
                    content.innerHTML = `
                        <h3 class="text-2xl font-bold mb-6 text-white border-l-4 border-neon-purple pl-3">Identidade do Site</h3>
                        <form onsubmit="window.saveSettings(event)" class="space-y-6 max-w-2xl">
                            <div>
                                <label class="block text-gray-400 text-sm mb-2">Nome do Site (T√≠tulo)</label>
                                <input type="text" id="siteName" value="${state.settings.siteName}" class="w-full p-3 bg-black border border-gray-700 rounded text-white" required>
                            </div>
                            <div>
                                <label class="block text-gray-400 text-sm mb-2">Mensagem de Boas-vindas</label>
                                <input type="text" id="welcomeMsg" value="${state.settings.welcomeMessage}" class="w-full p-3 bg-black border border-gray-700 rounded text-white" required>
                            </div>
                            <div>
                                <label class="block text-gray-400 text-sm mb-2">URL do Favicon</label>
                                <input type="url" id="faviconUrl" value="${state.settings.favicon || ''}" class="w-full p-3 bg-black border border-gray-700 rounded text-white">
                            </div>
                            <button type="submit" class="bg-neon-purple px-6 py-2 rounded font-bold text-white hover:bg-purple-700 w-full">Salvar Configura√ß√µes</button>
                        </form>
                    `;
                } else {
                    // TABS DE CONTE√öDO (Subject, Unit, Lesson)
                    let formHtml = '';
                    let listHtml = `<div class="mt-12"><h3 class="text-xl font-bold mb-4 text-gray-300">Itens Cadastrados</h3><div class="overflow-x-auto"><table class="w-full admin-table text-sm text-gray-400"><thead><tr><th>ID</th><th>T√≠tulo</th><th>A√ß√µes</th></tr></thead><tbody>`;
                    
                    // Fetch Data for List
                    const collectionName = type + 's'; // subject -> subjects
                    const snapshot = await getDocs(getColRef(collectionName));
                    const items = snapshot.docs.map(d => ({id: d.id, ...d.data()}));

                    // Generate Form HTML
                    if (type === 'subject') {
                        formHtml = `
                            <form onsubmit="window.handleSave(event, 'subject')" class="space-y-4 border-b border-gray-700 pb-8">
                                <h3 class="text-xl font-bold" id="formTitle">Nova Mat√©ria</h3>
                                <input type="text" id="title" placeholder="Nome da Mat√©ria" class="w-full p-3 bg-black border border-gray-700 rounded text-white" required>
                                <button type="submit" id="submitBtn" class="bg-neon-cyan text-black px-6 py-2 rounded font-bold">Criar Mat√©ria</button>
                                <button type="button" onclick="window.renderAdminTab('subject')" class="hidden text-red-500 ml-4 underline" id="cancelBtn">Cancelar</button>
                            </form>`;
                    } else if (type === 'unit') {
                        const subs = await getDocs(getColRef("subjects"));
                        const subOptions = subs.docs.map(d => `<option value="${d.id}">${d.data().title}</option>`).join('');
                        formHtml = `
                            <form onsubmit="window.handleSave(event, 'unit')" class="space-y-4 border-b border-gray-700 pb-8">
                                <h3 class="text-xl font-bold" id="formTitle">Nova Unidade</h3>
                                <select id="subjectId" class="w-full p-3 bg-black border border-gray-700 rounded text-white" required>${subOptions}</select>
                                <input type="text" id="title" placeholder="Nome da Unidade" class="w-full p-3 bg-black border border-gray-700 rounded text-white" required>
                                <button type="submit" id="submitBtn" class="bg-neon-cyan text-black px-6 py-2 rounded font-bold">Criar Unidade</button>
                                <button type="button" onclick="window.renderAdminTab('unit')" class="hidden text-red-500 ml-4 underline" id="cancelBtn">Cancelar</button>
                            </form>`;
                    } else if (type === 'lesson') {
                        const units = await getDocs(getColRef("units"));
                        const unitOptions = units.docs.map(d => `<option value="${d.id}">${d.data().title}</option>`).join('');
                        formHtml = `
                            <form onsubmit="window.handleSave(event, 'lesson')" class="space-y-4 border-b border-gray-700 pb-8">
                                <h3 class="text-xl font-bold" id="formTitle">Nova Aula</h3>
                                <select id="unitId" class="w-full p-3 bg-black border border-gray-700 rounded text-white" required>${unitOptions}</select>
                                <input type="text" id="title" placeholder="T√≠tulo da Aula" class="w-full p-3 bg-black border border-gray-700 rounded text-white" required>
                                <input type="url" id="videoUrl" placeholder="URL do YouTube" class="w-full p-3 bg-black border border-gray-700 rounded text-white" required>
                                <div id="editor" class="h-48 bg-gray-800 text-white"></div>
                                <input type="file" id="fileInput" class="w-full text-gray-400 mt-2">
                                <button type="submit" id="submitBtn" class="bg-neon-cyan text-black px-6 py-2 rounded font-bold mt-4">Criar Aula</button>
                                <button type="button" onclick="window.renderAdminTab('lesson')" class="hidden text-red-500 ml-4 underline" id="cancelBtn">Cancelar</button>
                            </form>`;
                    }

                    // Generate List HTML
                    items.forEach(item => {
                        listHtml += `
                            <tr>
                                <td class="font-mono text-xs text-gray-600">${item.id.substring(0,6)}...</td>
                                <td class="font-bold text-white">${item.title}</td>
                                <td>
                                    <button onclick="window.editItem('${type}', '${item.id}')" class="text-neon-cyan hover:underline mr-3">Editar</button>
                                    <button onclick="window.deleteItem('${collectionName}', '${item.id}', '${type}')" class="text-red-500 hover:underline">Excluir</button>
                                </td>
                            </tr>
                        `;
                    });
                    listHtml += '</tbody></table></div></div>';

                    content.innerHTML = formHtml + listHtml;
                    if(type === 'lesson') window.quillEditor = new Quill('#editor', { theme: 'snow' });
                }
            },

            // Salvar Configura√ß√µes Globais
            saveSettings: async (e) => {
                e.preventDefault();
                const settings = {
                    siteName: document.getElementById('siteName').value,
                    welcomeMessage: document.getElementById('welcomeMsg').value,
                    favicon: document.getElementById('faviconUrl').value
                };
                try {
                    await setDoc(getSettingsRef(), settings);
                    state.settings = settings;
                    mainApp.applySettings();
                    utils.showToast("Configura√ß√µes salvas!");
                } catch(err) { utils.showToast("Erro ao salvar."); }
            },

            // CRUD Gen√©rico (Create/Update)
            handleSave: async (e, type) => {
                e.preventDefault();
                const isEdit = !!state.editingId;
                const collectionName = type + 's';
                
                // Coleta dados b√°sicos
                let data = {
                    title: document.getElementById('title').value,
                    createdAt: new Date().toISOString() // Em edit, idealmente manteria a data original, mas simplificando
                };

                // Coleta dados espec√≠ficos
                if (type === 'unit') data.subjectId = document.getElementById('subjectId').value;
                if (type === 'lesson') {
                    data.unitId = document.getElementById('unitId').value;
                    data.videoUrl = document.getElementById('videoUrl').value;
                    data.summary = window.quillEditor.root.innerHTML;
                    
                    const fileInput = document.getElementById('fileInput');
                    if (fileInput.files[0]) {
                        const fileRef = ref(storage, `materials/${Date.now()}_${fileInput.files[0].name}`);
                        await uploadBytes(fileRef, fileInput.files[0]);
                        data.fileUrl = await getDownloadURL(fileRef);
                    }
                }

                try {
                    if (isEdit) {
                        // UPDATE
                        // Se for edit, n√£o sobrescrever createdAt se quiser manter ordem, mas aqui atualizamos
                        const docRef = getDocRef(collectionName, state.editingId);
                        // Se for lesson e n√£o houve upload, manter fileUrl antigo (necess√°rio l√≥gica extra, simplificado aqui)
                        await updateDoc(docRef, data);
                        utils.showToast("Item atualizado!");
                    } else {
                        // CREATE
                        await addDoc(getColRef(collectionName), data);
                        utils.showToast("Item criado!");
                    }
                    window.renderAdminTab(type); // Reload list and form
                } catch (err) { console.error(err); utils.showToast("Erro ao salvar."); }
            },

            // Preparar UI para Edi√ß√£o
            editItem: async (type, id) => {
                const docSnap = await getDoc(getDocRef(type + 's', id));
                if (!docSnap.exists()) return;
                const data = docSnap.data();

                state.editingId = id; // Set edit mode
                
                // Atualizar UI do form
                document.getElementById('formTitle').innerText = `Editar ${type} (ID: ${id.substring(0,4)}...)`;
                document.getElementById('submitBtn').innerText = "Atualizar";
                document.getElementById('submitBtn').classList.replace('bg-neon-cyan', 'bg-neon-green');
                document.getElementById('cancelBtn').classList.remove('hidden');

                // Preencher campos
                document.getElementById('title').value = data.title;
                if (type === 'unit') document.getElementById('subjectId').value = data.subjectId;
                if (type === 'lesson') {
                    document.getElementById('unitId').value = data.unitId;
                    document.getElementById('videoUrl').value = data.videoUrl;
                    window.quillEditor.root.innerHTML = data.summary || "";
                }
                
                // Scroll para o form
                document.getElementById('navbar').scrollIntoView();
            },

            deleteItem: async (collectionName, id, type) => {
                if (confirm("Tem certeza que deseja excluir? Isso n√£o pode ser desfeito.")) {
                    try {
                        await deleteDoc(getDocRef(collectionName, id));
                        utils.showToast("Item exclu√≠do.");
                        window.renderAdminTab(type);
                    } catch (err) { utils.showToast("Erro ao excluir."); }
                }
            }
        };

        // --- GLOBAL BINDINGS ---
        window.app = mainApp;
        window.authManager = {
            toggleModal: (s) => document.getElementById('loginModal').classList.toggle('hidden', !s),
            handleLogin: async () => {
                try {
                    await signInWithEmailAndPassword(auth, document.getElementById('emailInput').value, document.getElementById('passInput').value);
                    document.getElementById('loginModal').classList.add('hidden');
                } catch(e) { utils.showToast(e.message); }
            },
            handleRegister: async () => {
                try {
                    await createUserWithEmailAndPassword(auth, document.getElementById('emailInput').value, document.getElementById('passInput').value);
                    document.getElementById('loginModal').classList.add('hidden');
                } catch(e) { utils.showToast(e.message); }
            },
            logout: async () => { await signOut(auth); window.location.reload(); }
        };
        
        // Admin Bindings
        window.renderAdminTab = adminManager.renderTab;
        window.saveSettings = adminManager.saveSettings;
        window.handleSave = adminManager.handleSave;
        window.editItem = adminManager.editItem;
        window.deleteItem = adminManager.deleteItem;
        
        // Navigation Bindings
        window.playLesson = (id) => mainApp.router('player', id);
        window.startSeries = mainApp.startSeries;
        window.nextPhase = window.nextPhase; // Mantendo binding anterior se existir
        window.startSeries = mainApp.startSeries;

        // Player Logic Aux (Globals para o HTML acessar)
        window.nextPhase = (phase) => {
            document.querySelectorAll('.phase-container').forEach(el => el.classList.remove('phase-active'));
            if(phase === 2 && !window.hasFile) return window.nextPhase(3);
            if(phase === 3) {
                const text = utils.stripHtml(document.getElementById('summaryText').innerHTML);
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'pt-BR';
                u.onend = async () => {
                    utils.showToast("Aula Conclu√≠da!");
                    if(state.user && !state.user.isAnonymous) await setDoc(getUserRef(state.user.uid, "progress", window.currentLessonId), {concluido:true});
                    if(window.nextLessonId) mainApp.router('player', window.nextLessonId);
                    else mainApp.router('home');
                };
                speechSynthesis.speak(u);
            }
            document.getElementById(`phase${phase}`).classList.add('phase-active');
        };

        // Start
        mainApp.init();

        // Auth Listener
        onAuthStateChanged(auth, (user) => {
            state.user = user;
            const container = document.getElementById('authContainer');
            if (user) {
                if(user.isAnonymous) {
                     container.innerHTML = `<button onclick="authManager.toggleModal(true)" class="bg-netflix-red px-4 py-1 rounded text-white font-bold">Entrar</button>`;
                } else {
                    state.isAdmin = user.email && user.email.endsWith('@userpro.com');
                    document.getElementById('adminBtn').classList.toggle('hidden', !state.isAdmin);
                    container.innerHTML = `<button onclick="authManager.logout()" class="text-gray-400 hover:text-white">Sair (${user.email.split('@')[0]})</button>`;
                }
                if(state.currentView === 'home' && !user.isAnonymous) mainApp.renderHome(document.getElementById('app'));
            } else {
                signInAnonymously(auth).catch(e => console.log("Anon auth fail", e));
            }
        });

    </script>
</body>
</html>
