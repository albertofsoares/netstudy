<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyFlix - Sequential Learning</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Quill.js -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

    <!-- YouTube IFrame API (Obrigat√≥rio para controle de estado) -->
    <script src="https://www.youtube.com/iframe_api"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Configura√ß√£o de Design System -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        netflix: {
                            black: '#141414',
                            dark: '#181818',
                            red: '#E50914',
                            hover: '#2F2F2F'
                        },
                        neon: {
                            cyan: '#00f3ff',
                            purple: '#bc13fe',
                            green: '#39ff14'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fade-in': 'fadeIn 1s ease-in-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&display=swap');

        body {
            background-color: #141414;
            color: #e5e5e5;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #141414; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #E50914; }

        .neon-text { text-shadow: 0 0 10px rgba(0, 243, 255, 0.7); }
        
        .card-hover:hover {
            transform: scale(1.05);
            transition: all 0.3s ease;
            box-shadow: 0 0 20px rgba(188, 19, 254, 0.3);
            z-index: 10;
        }

        .scrolling-wrapper {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 20px;
            scroll-behavior: smooth;
        }
        .scrolling-wrapper::-webkit-scrollbar { display: none; }
        
        .card {
            flex: 0 0 auto;
            width: 300px;
            margin-right: 15px;
            background: #181818;
            border-radius: 4px;
            position: relative;
            cursor: pointer;
        }

        /* Player YouTube Otimizado para API */
        .video-container {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            border-radius: 8px;
            box-shadow: 0 0 50px rgba(0,0,0,0.9);
            border: 1px solid #333;
        }
        .video-container iframe, .video-container div {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
        }

        .ql-toolbar { background-color: #e5e5e5; border-radius: 8px 8px 0 0; }
        .ql-container { color: #e5e5e5; font-size: 16px; border-radius: 0 0 8px 8px; background-color: #2F2F2F; }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #E50914;
            border-radius: 50%;
            width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Estilos de Fase */
        .phase-container { display: none; }
        .phase-active { display: block; animation: fadeIn 0.5s ease-in-out; }
    </style>
</head>
<body class="antialiased">

    <!-- Navbar -->
    <nav class="fixed top-0 w-full z-50 bg-gradient-to-b from-black to-transparent px-8 py-4 flex justify-between items-center transition-all duration-300" id="navbar">
        <div class="flex items-center gap-8">
            <h1 class="text-3xl font-black text-netflix-red tracking-tighter cursor-pointer" onclick="app.router('home')">STUDYFLIX</h1>
            <ul class="hidden md:flex gap-4 text-sm font-medium text-gray-300">
                <li class="hover:text-white cursor-pointer transition" onclick="app.router('home')">In√≠cio</li>
            </ul>
        </div>
        <div class="flex items-center gap-4">
            <button id="adminBtn" class="hidden text-neon-cyan border border-neon-cyan px-3 py-1 rounded hover:bg-neon-cyan hover:text-black transition text-xs font-bold uppercase" onclick="app.router('admin')">
                Painel Admin
            </button>
            <div id="authContainer">
                <!-- Auth state injected here via JS -->
            </div>
        </div>
    </nav>

    <!-- App Container -->
    <main id="app" class="pt-24 min-h-screen px-4 md:px-12 pb-12">
        <div class="flex justify-center mt-20"><div class="loader"></div></div>
    </main>

    <!-- Modal de Login -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-80 hidden z-[60] flex items-center justify-center backdrop-blur-sm transition-opacity">
        <div class="bg-netflix-dark p-8 rounded-lg border border-gray-700 w-full max-w-md relative shadow-2xl shadow-purple-900/20">
            <button onclick="authManager.toggleModal(false)" class="absolute top-3 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
            
            <h2 class="text-3xl font-bold mb-6 text-white text-center">Entrar ou Cadastrar</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs text-gray-400 mb-1 ml-1 uppercase font-bold">E-mail</label>
                    <input type="email" id="emailInput" placeholder="exemplo@userpro.com" class="w-full p-3 bg-gray-800 text-white rounded border border-gray-600 focus:border-neon-cyan focus:outline-none transition">
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1 ml-1 uppercase font-bold">Senha</label>
                    <input type="password" id="passInput" placeholder="Sua senha secreta" class="w-full p-3 bg-gray-800 text-white rounded border border-gray-600 focus:border-neon-cyan focus:outline-none transition">
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button onclick="authManager.handleLogin()" class="flex-1 bg-netflix-red text-white font-bold py-3 rounded hover:bg-red-700 transition transform hover:scale-105">
                        Entrar
                    </button>
                    <button onclick="authManager.handleRegister()" class="flex-1 border border-gray-500 text-gray-300 font-bold py-3 rounded hover:border-white hover:text-white hover:bg-gray-800 transition">
                        Cadastrar
                    </button>
                </div>
                <p class="text-xs text-gray-500 text-center mt-4">
                    Para acesso Admin, use um e-mail terminando em <span class="text-neon-cyan">@userpro.com</span>
                </p>
            </div>
        </div>
    </div>

    <!-- Modal de Loading/Toast -->
    <div id="toast" class="fixed bottom-5 right-5 bg-netflix-dark border-l-4 border-neon-cyan p-4 rounded shadow-2xl transform translate-y-full transition-transform duration-300 z-50">
        <p id="toastMsg" class="text-white font-bold"></p>
    </div>

    <!-- Scripts Modulares -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, updateDoc, setDoc, query, where, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        // --- 1. FIREBASE CONFIG & HELPERS ---
        const firebaseConfig = {
            apiKey: "AIzaSyC38VXjnYskoAx5SLF6n3PiEgnaRtz4IJ0",
            authDomain: "studyflix53.firebaseapp.com",
            projectId: "studyflix53",
            storageBucket: "studyflix53.firebasestorage.app",
            messagingSenderId: "799853597162",
            appId: "1:799853597162:web:179f1450c419157d62a293"
        };

        const appId = "studyflix53";
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Helper para caminhos seguros
        const getColRef = (colName) => collection(db, 'artifacts', appId, 'public', 'data', colName);
        const getDocRef = (colName, docId) => doc(db, 'artifacts', appId, 'public', 'data', colName, docId);
        const getUserRef = (userId, subCol, docId) => doc(db, 'artifacts', appId, 'users', userId, subCol, docId);

        // --- 2. GEST√ÉO DE ESTADO & UTILIT√ÅRIOS ---
        const state = {
            user: null,
            isAdmin: false,
            currentView: 'home',
            data: { subjects: [], units: [], lessons: [] }
        };

        const utils = {
            showToast: (msg) => {
                const toast = document.getElementById('toast');
                const msgEl = document.getElementById('toastMsg');
                if(msgEl) {
                    msgEl.innerText = msg;
                    toast.classList.remove('translate-y-full');
                    setTimeout(() => toast.classList.add('translate-y-full'), 3000);
                }
            },
            getYouTubeID: (url) => {
                if (!url) return null;
                const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
                const match = url.match(regExp);
                return (match && match[2].length === 11) ? match[2] : null;
            },
            stripHtml: (html) => {
                let tmp = document.createElement("DIV");
                tmp.innerHTML = html;
                return tmp.textContent || tmp.innerText || "";
            }
        };

        // --- 3. LOGICA DE ADMIN (Mantida) ---
        const adminManager = {
            init: () => {
                if (!state.isAdmin) {
                    mainApp.router('home');
                    utils.showToast("Acesso Negado: Apenas administradores.");
                    return;
                }
                adminManager.renderDashboard();
            },

            renderDashboard: async () => {
                const container = document.getElementById('app');
                container.innerHTML = `
                    <div class="max-w-4xl mx-auto">
                        <h2 class="text-4xl font-bold mb-8 text-neon-cyan">Painel de Controle</h2>
                        
                        <div class="flex gap-4 mb-8 border-b border-gray-700 pb-4">
                            <button onclick="window.renderForm('subject')" class="text-white hover:text-neon-purple font-bold">Nova Mat√©ria</button>
                            <button onclick="window.renderForm('unit')" class="text-white hover:text-neon-purple font-bold">Nova Unidade</button>
                            <button onclick="window.renderForm('lesson')" class="text-white hover:text-neon-purple font-bold">Nova Aula</button>
                        </div>

                        <div id="adminContent" class="bg-netflix-dark p-6 rounded-lg shadow-lg">
                            <p class="text-gray-400">Selecione uma op√ß√£o acima para criar conte√∫do.</p>
                        </div>
                    </div>
                `;
            },

            saveSubject: async (e) => {
                e.preventDefault();
                const title = document.getElementById('subjectTitle').value;
                try {
                    await addDoc(getColRef("subjects"), { title, createdAt: new Date().toISOString() });
                    utils.showToast("Mat√©ria criada com sucesso!");
                    e.target.reset();
                } catch (err) { console.error(err); utils.showToast("Erro ao salvar: " + err.message); }
            },

            saveUnit: async (e) => {
                e.preventDefault();
                const title = document.getElementById('unitTitle').value;
                const subjectId = document.getElementById('unitSubject').value;
                try {
                    await addDoc(getColRef("units"), { title, subjectId, createdAt: new Date().toISOString() });
                    utils.showToast("Unidade criada com sucesso!");
                    e.target.reset();
                } catch (err) { console.error(err); utils.showToast("Erro ao salvar."); }
            },

            saveLesson: async (e) => {
                e.preventDefault();
                const title = document.getElementById('lessonTitle').value;
                const unitId = document.getElementById('lessonUnit').value;
                const videoUrl = document.getElementById('lessonVideo').value;
                const fileInput = document.getElementById('lessonFile');
                const summary = window.quillEditor.root.innerHTML;

                let fileUrl = "";
                if (fileInput.files[0]) {
                    try {
                        const fileRef = ref(storage, `materials/${Date.now()}_${fileInput.files[0].name}`);
                        await uploadBytes(fileRef, fileInput.files[0]);
                        fileUrl = await getDownloadURL(fileRef);
                    } catch (err) {
                        console.error("Storage error:", err);
                        utils.showToast("Erro no upload do arquivo.");
                    }
                }

                try {
                    await addDoc(getColRef("lessons"), {
                        title, unitId, videoUrl, summary, fileUrl, createdAt: new Date().toISOString()
                    });
                    utils.showToast("Aula publicada!");
                    e.target.reset();
                    window.quillEditor.setContents([]);
                } catch (err) { console.error(err); utils.showToast("Erro ao publicar aula."); }
            }
        };

        // Bindings Admin
        window.renderForm = async (type) => {
            const content = document.getElementById('adminContent');
            if (type === 'subject') {
                content.innerHTML = `
                    <form onsubmit="window.submitSubject(event)" class="space-y-4">
                        <h3 class="text-xl font-bold">Nova Mat√©ria (S√©rie)</h3>
                        <input type="text" id="subjectTitle" placeholder="Nome da Mat√©ria" class="w-full p-3 bg-black border border-gray-700 rounded text-white" required>
                        <button type="submit" class="bg-neon-purple px-6 py-2 rounded font-bold text-white hover:bg-purple-700">Salvar Mat√©ria</button>
                    </form>
                `;
            } else if (type === 'unit') {
                const subs = await getDocs(getColRef("subjects"));
                let options = "";
                subs.forEach(doc => options += `<option value="${doc.id}">${doc.data().title}</option>`);
                content.innerHTML = `
                    <form onsubmit="window.submitUnit(event)" class="space-y-4">
                        <h3 class="text-xl font-bold">Nova Unidade (Temporada)</h3>
                        <select id="unitSubject" class="w-full p-3 bg-black border border-gray-700 rounded text-white" required>${options}</select>
                        <input type="text" id="unitTitle" placeholder="Nome da Unidade" class="w-full p-3 bg-black border border-gray-700 rounded text-white" required>
                        <button type="submit" class="bg-neon-purple px-6 py-2 rounded font-bold text-white hover:bg-purple-700">Salvar Unidade</button>
                    </form>
                `;
            } else if (type === 'lesson') {
                const units = await getDocs(getColRef("units"));
                let options = "";
                units.forEach(doc => options += `<option value="${doc.id}">${doc.data().title}</option>`);
                content.innerHTML = `
                    <form onsubmit="window.submitLesson(event)" class="space-y-4">
                        <h3 class="text-xl font-bold">Nova Aula (Epis√≥dio)</h3>
                        <select id="lessonUnit" class="w-full p-3 bg-black border border-gray-700 rounded text-white" required>${options}</select>
                        <input type="text" id="lessonTitle" placeholder="T√≠tulo da Aula" class="w-full p-3 bg-black border border-gray-700 rounded text-white" required>
                        <input type="url" id="lessonVideo" placeholder="URL do YouTube" class="w-full p-3 bg-black border border-gray-700 rounded text-white" required>
                        <label class="block text-sm text-gray-400">Resumo da Aula</label>
                        <div id="editor" class="h-48 bg-gray-800"></div>
                        <label class="block text-sm text-gray-400 mt-4">Material Complementar (PDF/Audio)</label>
                        <input type="file" id="lessonFile" class="w-full text-gray-400">
                        <button type="submit" class="mt-4 bg-neon-cyan text-black px-6 py-2 rounded font-bold hover:bg-cyan-400 w-full">Publicar Aula</button>
                    </form>
                `;
                window.quillEditor = new Quill('#editor', { theme: 'snow' });
            }
        };
        window.submitSubject = adminManager.saveSubject;
        window.submitUnit = adminManager.saveUnit;
        window.submitLesson = adminManager.saveLesson;


        // --- 4. L√ìGICA DO PLAYER E ROTEAMENTO (REESCRITO) ---
        let ytPlayer; // Variavel global para o player do YouTube

        const mainApp = {
            router: (view, params = null) => {
                state.currentView = view;
                const appDiv = document.getElementById('app');
                
                // Parar fala ao mudar de tela
                window.speechSynthesis.cancel();
                
                if (view === 'home') mainApp.renderHome(appDiv);
                else if (view === 'player') mainApp.renderPlayer(appDiv, params);
                else if (view === 'admin') adminManager.init();
            },

            // --- AUTO-ROTEAMENTO INTELIGENTE ---
            startSeries: async (subjectId) => {
                utils.showToast("Buscando primeira aula...");
                
                // 1. Achar a primeira unidade desta mat√©ria
                const unitsSnap = await getDocs(query(getColRef("units"), where("subjectId", "==", subjectId)));
                if(unitsSnap.empty) return utils.showToast("Sem unidades nesta mat√©ria.");
                
                // Ordenar unidades (por data pois nao temos campo ordem)
                const units = unitsSnap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => a.createdAt.localeCompare(b.createdAt));
                const firstUnit = units[0];

                // 2. Achar a primeira aula desta unidade
                const lessonsSnap = await getDocs(query(getColRef("lessons"), where("unitId", "==", firstUnit.id)));
                if(lessonsSnap.empty) return utils.showToast("Sem aulas nesta unidade.");
                
                const lessons = lessonsSnap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => a.createdAt.localeCompare(b.createdAt));
                
                // 3. Redirecionar
                mainApp.router('player', lessons[0].id);
            },

            renderHome: async (container) => {
                container.innerHTML = `<div class="flex justify-center mt-20"><div class="loader"></div></div>`;
                try {
                    const subSnap = await getDocs(getColRef("subjects"));
                    const unitSnap = await getDocs(getColRef("units"));
                    const lessonSnap = await getDocs(getColRef("lessons"));

                    let html = `
                        <div class="mb-10">
                            <h1 class="text-5xl md:text-7xl font-black mb-4 text-white">Aprenda <br><span class="text-neon-cyan neon-text">Sequencialmente.</span></h1>
                            <p class="text-xl text-gray-400 max-w-2xl">Clique no t√≠tulo da mat√©ria para iniciar sua jornada do come√ßo.</p>
                        </div>
                    `;

                    if (subSnap.empty) html += `<div class="text-gray-500">Nenhum conte√∫do.</div>`;

                    subSnap.forEach(sub => {
                        // T√≠tulo clic√°vel para "Auto-Roteamento"
                        html += `
                            <div class="flex items-center gap-4 mt-12 mb-4 group cursor-pointer" onclick="window.startSeries('${sub.id}')">
                                <h2 class="text-3xl font-bold text-white group-hover:text-neon-cyan transition">${sub.data().title}</h2>
                                <div class="bg-netflix-red text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition">
                                    <i class="fas fa-play"></i> INICIAR JORNADA
                                </div>
                            </div>
                        `;
                        
                        const subUnits = unitSnap.docs.filter(u => u.data().subjectId === sub.id);
                        subUnits.forEach(unit => {
                            html += `
                                <div class="mb-6 ml-4">
                                    <h3 class="text-lg text-gray-400 mb-2 uppercase tracking-widest text-sm font-bold">${unit.data().title}</h3>
                                    <div class="scrolling-wrapper">
                            `;
                            const unitLessons = lessonSnap.docs.filter(l => l.data().unitId === unit.id);
                            unitLessons.forEach(lesson => {
                                const ytId = utils.getYouTubeID(lesson.data().videoUrl);
                                const thumb = ytId ? `https://img.youtube.com/vi/${ytId}/mqdefault.jpg` : 'https://placehold.co/300x169';
                                html += `
                                    <div class="card card-hover" onclick="window.playLesson('${lesson.id}')">
                                        <div class="h-40 overflow-hidden rounded-t">
                                            <img src="${thumb}" class="w-full h-full object-cover opacity-80 hover:opacity-100 transition">
                                        </div>
                                        <div class="p-3">
                                            <h4 class="text-white font-bold text-sm truncate">${lesson.data().title}</h4>
                                            <span class="text-xs text-gray-500">Clique para ir direto</span>
                                        </div>
                                    </div>`;
                            });
                            html += `</div></div>`;
                        });
                    });
                    container.innerHTML = html;
                } catch (e) { container.innerHTML = `<p class="text-red-500">Erro: ${e.message}</p>`; }
            },

            // --- M√ÅQUINA DE ESTADOS DO PLAYER ---
            renderPlayer: async (container, lessonId) => {
                container.innerHTML = `<div class="flex justify-center mt-20"><div class="loader"></div></div>`;
                
                try {
                    const docRef = getDocRef("lessons", lessonId);
                    const docSnap = await getDoc(docRef);
                    if (!docSnap.exists()) return container.innerHTML = "Aula n√£o encontrada.";
                    
                    const data = docSnap.data();
                    const ytId = utils.getYouTubeID(data.videoUrl);

                    // Buscar pr√≥xima aula (Binge-Watching)
                    const unitLessonsSnap = await getDocs(query(getColRef("lessons"), where("unitId", "==", data.unitId)));
                    const unitLessons = unitLessonsSnap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => a.createdAt.localeCompare(b.createdAt));
                    const currentIndex = unitLessons.findIndex(l => l.id === lessonId);
                    const nextLessonId = (currentIndex !== -1 && currentIndex < unitLessons.length - 1) ? unitLessons[currentIndex + 1].id : null;

                    container.innerHTML = `
                        <div class="max-w-5xl mx-auto animate-fade-in relative min-h-[80vh] flex flex-col justify-center">
                            <!-- Header Fixo -->
                            <div class="absolute top-0 left-0 w-full flex justify-between items-center mb-6 z-10">
                                <button onclick="app.router('home')" class="text-gray-400 hover:text-white flex items-center gap-2">
                                    <i class="fas fa-arrow-left"></i> Sair da Aula
                                </button>
                                <span class="text-sm text-gray-500 uppercase font-bold tracking-widest">Aula ${currentIndex + 1}/${unitLessons.length}</span>
                            </div>

                            <!-- FASE 1: V√çDEO (IMERSIVO) -->
                            <div id="phase1" class="phase-container phase-active w-full">
                                <h1 class="text-3xl font-bold mb-4 text-white text-center">${data.title}</h1>
                                <div class="video-container mx-auto">
                                    <div id="yt-player"></div>
                                </div>
                                <p class="text-center text-gray-500 mt-4 text-sm animate-pulse">Assistindo... O pr√≥ximo passo inicia automaticamente ao fim do v√≠deo.</p>
                            </div>

                            <!-- FASE 2: MATERIAL (LEITURA) -->
                            <div id="phase2" class="phase-container w-full text-center">
                                <h2 class="text-3xl font-bold mb-8 text-white">Hora da Leitura üìö</h2>
                                ${data.fileUrl ? `
                                    <div class="bg-gray-800 p-8 rounded-lg border border-gray-700 max-w-2xl mx-auto mb-8">
                                        <i class="fas fa-file-pdf text-6xl text-red-500 mb-4"></i>
                                        <p class="mb-6 text-xl">Material Complementar Dispon√≠vel</p>
                                        <a href="${data.fileUrl}" target="_blank" class="bg-white text-black px-6 py-3 rounded font-bold hover:bg-gray-200 transition">
                                            Abrir Material
                                        </a>
                                    </div>
                                ` : '<p class="text-gray-500 mb-8">Nenhum anexo nesta aula.</p>'}
                                
                                <button onclick="window.nextPhase(3)" class="bg-neon-cyan text-black text-xl font-bold px-8 py-4 rounded-full hover:bg-cyan-300 transition shadow-[0_0_20px_rgba(0,243,255,0.4)]">
                                    Terminei a Leitura: Ouvir Resumo <i class="fas fa-arrow-right ml-2"></i>
                                </button>
                            </div>

                            <!-- FASE 3: RESUMO E CONCLUS√ÉO -->
                            <div id="phase3" class="phase-container w-full">
                                <div class="max-w-3xl mx-auto bg-netflix-dark p-8 rounded-lg border border-neon-purple shadow-[0_0_30px_rgba(188,19,254,0.2)]">
                                    <div class="flex items-center gap-4 mb-6">
                                        <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                                        <h2 class="text-2xl font-bold text-white">Ouvindo Resumo...</h2>
                                    </div>
                                    <div id="summaryText" class="prose prose-invert prose-lg text-gray-300 leading-relaxed mb-6">
                                        ${data.summary || "Esta aula n√£o possui resumo escrito."}
                                    </div>
                                    <p class="text-sm text-gray-500 italic text-center">A aula ser√° conclu√≠da automaticamente ao fim do √°udio.</p>
                                </div>
                            </div>
                        </div>
                    `;

                    // L√≥gica de Controle de Fases
                    window.currentLessonId = lessonId;
                    window.nextLessonId = nextLessonId;
                    window.hasFile = !!data.fileUrl;

                    // Inicializar YouTube API
                    if (window.YT && window.YT.Player) {
                        new YT.Player('yt-player', {
                            height: '100%',
                            width: '100%',
                            videoId: ytId,
                            playerVars: { 'autoplay': 1, 'controls': 1, 'rel': 0 },
                            events: {
                                'onStateChange': (event) => {
                                    // Se o video terminou (Code 0), vai pra fase 2
                                    if (event.data === YT.PlayerState.ENDED) {
                                        window.nextPhase(2);
                                    }
                                }
                            }
                        });
                    }

                } catch (e) { container.innerHTML = "Erro: " + e.message; }
            }
        };

        // --- FUN√á√ïES GLOBAIS DE CONTROLE DE FASE ---
        
        window.nextPhase = (phaseNum) => {
            // Esconder todas as fases
            document.querySelectorAll('.phase-container').forEach(el => el.classList.remove('phase-active'));
            
            // Logica Fase 2
            if (phaseNum === 2) {
                if (!window.hasFile) {
                    // Se n√£o tem arquivo, pula direto pra 3
                    window.nextPhase(3);
                    return;
                }
                document.getElementById('phase2').classList.add('phase-active');
            }

            // Logica Fase 3 (Resumo + Audio + Conclus√£o)
            if (phaseNum === 3) {
                document.getElementById('phase3').classList.add('phase-active');
                
                const summaryEl = document.getElementById('summaryText');
                const text = utils.stripHtml(summaryEl.innerHTML);

                if (!text || text.trim() === "") {
                    // Se n√£o tem texto, conclui direto
                    setTimeout(() => window.markCompleteAndNext(), 2000);
                    return;
                }

                // Iniciar Voz
                const synth = window.speechSynthesis;
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'pt-BR';
                utterance.rate = 1.1;
                
                // Evento: Quando terminar de falar
                utterance.onend = () => {
                    window.markCompleteAndNext();
                };

                synth.cancel(); // Parar anteriores
                synth.speak(utterance);
            }
        };

        // --- AUTO-AVAN√áO (BINGE-WATCHING) ---
        window.markCompleteAndNext = async () => {
            utils.showToast("‚úÖ Aula Conclu√≠da!");
            
            // 1. Salvar Progresso
            if(state.user && !state.user.isAnonymous) {
                try {
                    const ref = getUserRef(state.user.uid, "progress", window.currentLessonId);
                    await setDoc(ref, { concluido: true, date: new Date().toISOString() });
                } catch(e) { console.error("Erro ao salvar progresso", e); }
            }

            // 2. Redirecionar
            if (window.nextLessonId) {
                utils.showToast("‚è≠Ô∏è Iniciando pr√≥xima aula em 3s...");
                setTimeout(() => {
                    mainApp.router('player', window.nextLessonId);
                }, 3000);
            } else {
                utils.showToast("üéâ Unidade Finalizada! Voltando ao in√≠cio.");
                setTimeout(() => {
                    mainApp.router('home');
                }, 3000);
            }
        };

        // --- AUTH E BINDS (Mantidos) ---
        const authManager = {
            toggleModal: (show) => {
                const modal = document.getElementById('loginModal');
                show ? modal.classList.remove('hidden') : modal.classList.add('hidden');
            },
            handleLogin: async () => {
                const email = document.getElementById('emailInput').value;
                const pass = document.getElementById('passInput').value;
                if(!email || !pass) return utils.showToast("Preencha email e senha.");
                try {
                    await signInWithEmailAndPassword(auth, email, pass);
                    authManager.toggleModal(false);
                    utils.showToast("Login realizado!");
                } catch (error) { utils.showToast("Erro: " + error.message); }
            },
            handleRegister: async () => {
                const email = document.getElementById('emailInput').value;
                const pass = document.getElementById('passInput').value;
                if(!email || !pass) return utils.showToast("Preencha dados.");
                if(pass.length < 6) return utils.showToast("Senha min. 6 digitos");
                try {
                    await createUserWithEmailAndPassword(auth, email, pass);
                    authManager.toggleModal(false);
                    utils.showToast("Cadastro realizado!");
                } catch (error) { utils.showToast("Erro: " + error.message); }
            },
            logout: async () => {
                await signOut(auth);
                window.location.reload(); 
            }
        };

        onAuthStateChanged(auth, (user) => {
            state.user = user;
            const authContainer = document.getElementById('authContainer');
            const adminBtn = document.getElementById('adminBtn');

            if (user) {
                if (user.isAnonymous) {
                     state.isAdmin = false;
                     adminBtn.classList.add('hidden');
                     authContainer.innerHTML = `<button onclick="authManager.toggleModal(true)" class="bg-netflix-red px-4 py-1 rounded text-white font-bold hover:bg-red-700 transition">Entrar</button>`;
                } else {
                    if (user.email && user.email.endsWith('@userpro.com')) {
                        state.isAdmin = true;
                        adminBtn.classList.remove('hidden');
                    } else {
                        state.isAdmin = false;
                        adminBtn.classList.add('hidden');
                    }
                    authContainer.innerHTML = `
                        <div class="flex items-center gap-3">
                            <span class="text-xs text-gray-400 hidden md:block">${user.email.split('@')[0]}</span>
                            <img src="https://ui-avatars.com/api/?background=random&name=${user.email}" class="w-8 h-8 rounded border border-gray-600">
                            <button onclick="authManager.logout()" class="text-xs border border-gray-600 px-2 py-1 rounded text-gray-400 hover:text-white transition">Sair</button>
                        </div>
                    `;
                }
                if (state.currentView === 'home' && !user.isAnonymous) mainApp.renderHome(document.getElementById('app'));
            } else {
                // Modified Error Handling for Anonymous Login
                state.isAdmin = false;
                adminBtn.classList.add('hidden');
                authContainer.innerHTML = `<button onclick="authManager.toggleModal(true)" class="bg-netflix-red px-4 py-1 rounded text-white font-bold hover:bg-red-700 transition">Entrar</button>`;

                signInAnonymously(auth).catch(error => {
                    const ignoredErrors = ['auth/admin-restricted-operation', 'auth/operation-not-allowed', 'auth/missing-android-pkg-name'];
                    if (!ignoredErrors.includes(error.code)) {
                        console.error("Erro auth an√¥nimo:", error);
                    } else {
                        console.log("Login an√¥nimo n√£o habilitado. Aguardando login manual.");
                    }
                });
            }
        });

        window.app = mainApp;
        window.authManager = authManager;
        window.playLesson = (id) => mainApp.router('player', id);
        window.startSeries = mainApp.startSeries;
    </script>
</body>
</html>
